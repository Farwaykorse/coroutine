# ---------------------------------------------------------------------------
#
#   Author
#     - luncliff@gmail.com
#   Reference
#     - https://docs.travis-ci.com/user/languages/cpp/
#     - https://libcxx.llvm.org/docs/BuildingLibcxx.html
#
# ---------------------------------------------------------------------------
sudo: false

git:
  submodules: false # - git submodule update --init --recursive
  depth: 1
  
notifications:
  email:
    - luncliff@gmail.com

language: cpp

before_install:
  - uname;
  - echo $TRAVIS_OS_NAME;

install:
  # Download llvm/libc++ via Github submodule
  #   This is a little bit slower than svn
  - if [ "${TRAVIS_OS_NAME}" == "linux" ]; then 
      git submodule update --init llvm libcxx libcxxabi;
    fi
  # - if [ "${TRAVIS_OS_NAME}" == "linux" ]; then 
  #     svn co http://llvm.org/svn/llvm-project/llvm/trunk llvm > /dev/null;
  #     pushd llvm; svn log -l 1; popd;
  #     svn co http://llvm.org/svn/llvm-project/libcxx/trunk libcxx > /dev/null;
  #     pushd libcxx; svn log -l 1; popd;
  #     svn co http://llvm.org/svn/llvm-project/libcxxabi/trunk libcxxabi > /dev/null;
  #     pushd libcxxabi; svn log -l 1; popd;
  #   fi
  # Linux: Build libcxx
  - if [ "${TRAVIS_OS_NAME}" == "linux" ]; then 
      mkdir -p prebuilt && pushd prebuilt;
      cmake ../libcxx -DLLVM_PATH=../llvm -DLIBCXX_CXX_ABI=libcxxabi -DLIBCXX_CXX_ABI_INCLUDE_PATHS=../libcxxabi/include -DCMAKE_INSTALL_PREFIX=. -DCMAKE_BUILD_TYPE=Release ;
      make -j10 install;
      rm CMakeCache.txt;
      tree ./include;
      popd;
    fi
  # Linux: Build libcxxabi
  - if [ "${TRAVIS_OS_NAME}" == "linux" ]; then 
      mkdir -p prebuilt && pushd prebuilt;
      cmake ../libcxxabi -DLLVM_PATH=../llvm/ -DLIBCXXABI_LIBCXX_PATH=../libcxx/ -DCMAKE_INSTALL_PREFIX=../prebuilt/ ;
      make -j10 install;
      rm CMakeCache.txt;
      tree ./lib;
      popd;
    fi
  # MacOS: Upgrade llvm
  - if [ "${TRAVIS_OS_NAME}" == "osx" ]; then 
      brew info llvm;
    fi
  - tree --version
  - ninja --version

before_script:
  - cd ${TRAVIS_BUILD_DIR}
  # Create & Go to build directory
  - mkdir p build;
  - pushd build;

script:
  - cmake ../ 
    -G "Ninja" 
    -DBUILD_SHARED_LIBS=$BUILD_SHARED 
    -DCMAKE_BUILD_TYPE=$CONFIG
    -DCMAKE_INSTALL_PREFIX=../install
  - ninja install
  # Display build results and start tests
  - ./cppmagic_test
  - tree -f ./CMakeFiles/

after_success:
  - popd;
  - tree ./install
  # MacOS: Run coverage tool 
  - if [ "${TRAVIS_OS_NAME}" == "osx" && ("$CONFIG" == "Debug") ]; then 
      cp ./CMakeFiles/cppmagic_test.dir/test/test.entry.cpp.* ./ ;
      gcov -abcf ./test.entry.cpp.gcda ;
      lcov --directory . --gcov-tool gcov --capture -o cov.info ;
      genhtml cov.info -o cov_report;
    fi

matrix: 
  include:
    # Linux : x86_64 Release Dynamic
    - os: linux
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-5.0
          packages:
            - clang-5.0
            - libc++-dev  
            - libc++1
            - libc++-dev
            - libc++abi1
            - libc++abi-dev
            - ninja-build
            - tree
      compiler: 
        - clang
      env:
        - PLATFORM=linux
        - CONFIG=Release
        - BUILD_SHARED=true

    # OS X : x86_64 Debug Dynamic
    - os: osx
      osx_image: xcode9.4
      addons:
        homebrew:
          # - brew update > /dev/null 2>&1;
          # - brew info llvm;
          update: true
          packages:
            - ninja
            - tree
            - llvm
      compiler: 
        - clang
      env:
        - PLATFORM=osx
        - CONFIG=Debug
        - BUILD_SHARED=true

    # Android JNI: armeabi-v7a
    - language: android
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - wget
            - unzip
            - tree
      android:
        components:
          - tools
          - platform-tools
          - android-21
          - sys-img-armeabi-v7a-android-21
      env:
        - MAJOR_ABI=armeabi-v7a
      before_install:
        - sudo apt-get install wget unzip tree
      install:
        # Accept SDK Licenses + Install NDK
        - yes | sdkmanager --update > /dev/null 2>&1
        - sdkmanager ndk-bundle > /dev/null 2>&1
        # Download/Install Gradle 
        - wget https://services.gradle.org/distributions/gradle-4.4-bin.zip
        - mkdir -p gradle
        - unzip -q -d ./gradle gradle-4.4-bin.zip
        - export GRADLE=gradle/gradle-4.4/bin/gradle
      before_script:
        - bash $GRADLE --version
      script:
        - bash $GRADLE clean assemble
      after_success:
        - cd ${TRAVIS_BUILD_DIR}
        - tree ./install

    # iPhone OS 10.3 : armv7 armv7s arm64 Debug Dynamic
    - os: osx
      osx_image: xcode9.4
      addons:
        homebrew:
          # - brew update > /dev/null 2>&1;
          # - brew info llvm;
          update: true
          packages:
            - ninja
            - tree
            - llvm
      compiler: 
        - clang
      env:
        - PLATFORM=iOS
        - CONFIG=Debug
        - BUILD_SHARED=true
      install:
        - brew info llvm;
        - git submodule update --init ios-cmake;
      script:
        - cmake ../ 
          -DBUILD_SHARED_LIBS=$BUILD_SHARED
          -DCMAKE_BUILD_TYPE=$CONFIG
          -DCMAKE_TOOLCHAIN_FILE=../ios-cmake/ios.toolchain.cmake 
          -DIOS_DEPLOYMENT_TARGET=10.3
          -DENABLE_BITCODE=false 
          -DCMAKE_INSTALL_PREFIX=../install
        - make -j10 install
        - file libcppmagic.dylib
      after_success:
        - cd ${TRAVIS_BUILD_DIR}
        - tree ./install

