#
#   Author
#     - luncliff@gmail.com
#   Reference
#     - https://www.appveyor.com/docs/appveyor-yml/
#     - https://github.com/appveyor/ci/issues/899#issuecomment-230360978
#
version: 1.4.{build}

branches:
  except:
    - docs

clone_script:  
  - ps: git clone -q --recursive --branch $env:APPVEYOR_REPO_BRANCH https://github.com/$env:APPVEYOR_REPO_NAME.git $env:APPVEYOR_BUILD_FOLDER

notifications:
  - provider: Email
    to:
      - luncliff@gmail.com

image:
  - Visual Studio 2017

platform:
  - x64

configuration:
  - Debug
  - Release

environment:
  matrix:
    - compiler: msvc
    - compiler: clang

matrix:
  allow_failures:
    - image: Visual Studio 2017
      compiler: clang

for:
  # MSVC: use Visual Studio solution file
  - matrix:
      only:
        - image: Visual Studio 2017
          compiler: msvc
    build:
      parallel: true
      project: coroutine.sln
      verbosity: quiet
    before_test:
      - ps: Write-Host $env:APPVEYOR_BUILD_FOLDER $env:PLATFORM $env:CONFIGURATION 
      - ps: $outdir=Join-Path -Path (pwd)   -ChildPath $env:PLATFORM
      - ps: $outdir=Join-Path -Path $outdir -ChildPath $env:CONFIGURATION
      - ps: Write-Host $outdir
    test_script:
      - ps: vstest.console "$outdir\coroutine_vstest_channel.dll"
      - ps: vstest.console "$outdir\coroutine_vstest_concrt.dll"
      - ps: vstest.console "$outdir\coroutine_vstest_network.dll"
      - ps: vstest.console "$outdir\coroutine_vstest_return.dll"
      - ps: vstest.console "$outdir\coroutine_vstest_yield.dll"

  # clang-cl: use CMake + Ninja + Clang
  # The build step expects cmdlet environment...
  - matrix:
      only:
        - image: Visual Studio 2017
          compiler: clang
    install:
      - ps: Write-Host $env:APPVEYOR_BUILD_FOLDER $env:PLATFORM $env:CONFIGURATION 
      - ps: choco install --yes --no-progress ninja   # Download Ninja with chocolaty package manager
      - ps: choco install --force --yes --no-progress cmake
      - ps: choco info    llvm    # LLVM is already installed. So just show the version info
    before_build:
      - ps: clang-cl --version # <-- cl.exe for clang
      - ps: New-Item -Name build -ItemType Directory
    build_script:
      - ps: Push-Location -Path build
      - cmd: call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" x86_amd64
      - cmd: set CXX=clang-cl # ps: $env:CXX = "clang-cl"
      # for cmake, "-DCMAKE_CXX_COMPILER=clang-cl" can be ok
      - cmd: cmake ../ -G Ninja -DUSE_CUSTOM_HEADER=true -DBUILD_SHARED_LIBS=false -DCMAKE_BUILD_TYPE=%configuration% -DCMAKE_INSTALL_PREFIX=../install/%platform%/%configuration%
      - cmd: cmake --build . --parallel
      - cmd: cmake --build . --target install
    after_build:
      - ps: Pop-Location
    before_test:
      - ps: Push-Location -Path build
    test_script:
      - ps: ctest --output-on-failure
